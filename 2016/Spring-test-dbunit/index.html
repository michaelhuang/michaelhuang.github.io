<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Spring Test Dbunit · learn to love less</title><meta name="description" content="Spring Test Dbunit - huangzhf"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/Source-Sans-Pro.css" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/ZhengfeiHuang" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/michaelhuang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Spring Test Dbunit</h1><div class="post-info">Apr 20, 2016</div><div class="post-content"><blockquote>
<p>如何基于 <code>Spring testing framework + DBUnit</code> 简单实现一个自动化测试工具？</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@DataSets</span>(setUpDataSet = <span class="string">"setUp.xls"</span>, expectDataSet = <span class="string">"expect.xls"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试方法执行前，先load<code>setUp.xls</code>中数据到测试库，测试方法结束后，自动和<code>expect.xls</code>中数据做比对；excel里面保存的是表的数据，多个表以多个sheet页形式体现，<code>sheet name</code>即是<code>table name</code>；其实github上已经有个功能非常完善的工具<a href="http://springtestdbunit.github.io/spring-test-dbunit/index.html" target="_blank" rel="external">Spring Test DBUnit</a>，这里只是说下大体实现思路</p>
<a id="more"></a>
<h2 id="定义注解"><a href="#定义注解" class="headerlink" title="定义注解"></a>定义注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DataSets &#123;</span><br><span class="line">  <span class="function">String <span class="title">setUpDataSet</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">  <span class="function">String <span class="title">expectDataSet</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化XlsFileLoader和DataSourceDatabaseTester"><a href="#初始化XlsFileLoader和DataSourceDatabaseTester" class="headerlink" title="初始化XlsFileLoader和DataSourceDatabaseTester"></a>初始化XlsFileLoader和DataSourceDatabaseTester</h2><p><code>dbunit-2.4.8</code>中已经有现成的<code>org.dbunit.util.fileloader.XlsDataFileLoader</code>，蛋疼的是它是从<code>getClass().getResource(filename)</code>加载，建议重写一个，从<code>ClassPathResource(filename).getURL()</code>加载</p>
<p>一般项目构建都会配置<code>dataSource</code>，所以用<code>DataSourceDatabaseTester</code>再合适不过，它来管理测试过程中数据库连接的创建销毁，以及最最重要的，根据具体<code>DatabaseOperation</code>处理数据集；有个地方要注意一下，连接属性最好设置一下数据库类型，方式是实现<code>IOperationListener</code>接口中<code>connectionRetrieved()</code>加入下面代码，这个方法会在每次new或retrieved一个连接后立即调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connection.getConfig().setProperty(DatabaseConfig.PROPERTY_DATATYPE_FACTORY, <span class="keyword">new</span> MySqlDataTypeFactory())</span><br></pre></td></tr></table></figure></p>
<p>配置bean<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ImportResource</span>(<span class="string">"classpath:/application-root-bean.xml"</span>)</span><br><span class="line"><span class="meta">@Profile</span>(<span class="string">"test"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceTestConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  DataSource dataSource;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span>(name=<span class="string">"databaseTester"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSourceDatabaseTester <span class="title">dataSourceDatabaseTester</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    DataSourceDatabaseTester databaseTester = <span class="keyword">new</span> DataSourceDatabaseTester(dataSource());</span><br><span class="line">    databaseTester.setOperationListener(<span class="keyword">new</span> CustOperationListener());</span><br><span class="line">    <span class="keyword">return</span> databaseTester;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span>(name=<span class="string">"xlsDataFileLoader"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> CustomXlsFileLoader <span class="title">xlsDataFileLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CustomXlsFileLoader();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="实现TestExecutionListener"><a href="#实现TestExecutionListener" class="headerlink" title="实现TestExecutionListener"></a>实现TestExecutionListener</h2><ul>
<li>首先<code>prepareTestInstance()</code>中<code>DI</code></li>
<li>接着<code>beforeTestMethod()</code>中加载<code>setUpDataSet</code></li>
<li>最后<code>afterTestMethod()</code>中比对<code>expectDataSet</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceTestExecutionListener</span> <span class="keyword">implements</span> <span class="title">TestExecutionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> IDatabaseTester databaseTester;</span><br><span class="line">  <span class="keyword">private</span> CustomXlsFileLoader xlsFileLoader;</span><br><span class="line">  <span class="keyword">private</span> IDataSet expectDataSet;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepareTestInstance</span><span class="params">(TestContext testCtx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    databaseTester = (IDatabaseTester) testCtx.getApplicationContext().getBean(<span class="string">"databaseTester"</span>);</span><br><span class="line">    xlsFileLoader = (CustomXlsFileLoader) testCtx.getApplicationContext().getBean(<span class="string">"xlsDataFileLoader"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTestMethod</span><span class="params">(TestContext testCtx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// Check for existence of DataSets annotation for the method under testing</span></span><br><span class="line">    DataSets dataSetAnnotation = testCtx.getTestMethod().getAnnotation(DataSets.class);</span><br><span class="line">    <span class="keyword">if</span> ( dataSetAnnotation == <span class="keyword">null</span> ) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String dataSetName = dataSetAnnotation.setUpDataSet();</span><br><span class="line">    <span class="keyword">if</span> ( ! <span class="string">""</span>.equals(dataSetName) ) &#123;</span><br><span class="line">      IDataSet dataSet = xlsFileLoader.load(dataSetName);</span><br><span class="line">      databaseTester.setDataSet(dataSet);</span><br><span class="line">      databaseTester.onSetup();</span><br><span class="line">    &#125;</span><br><span class="line">    String expectDataName = dataSetAnnotation.expectDataSet();</span><br><span class="line">    <span class="keyword">if</span> ( ! <span class="string">""</span>.equals(expectDataName)) &#123;</span><br><span class="line">      expectDataSet = xlsFileLoader.load(expectDataName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTestMethod</span><span class="params">(TestContext testCtx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="keyword">null</span> != expectDataSet &amp;&amp; <span class="keyword">null</span> != databaseTester) &#123;</span><br><span class="line">        IDatabaseConnection connection = databaseTester.getConnection();</span><br><span class="line">        connection.getConfig().setProperty(DatabaseConfig.PROPERTY_DATATYPE_FACTORY, <span class="keyword">new</span> MySqlDataTypeFactory());</span><br><span class="line">        IDataSet actualDataSet = connection.createDataSet();</span><br><span class="line">        Assert.assertNotNull(actualDataSet);</span><br><span class="line">        <span class="keyword">for</span> (String tableName : expectDataSet.getTableNames()) &#123;</span><br><span class="line">          <span class="comment">// 以expectDataSet中字段为准，比如CREATE_TIME, MODIFY_TIME这种字段比较是没有意义的</span></span><br><span class="line">          ITable filteredTable = DefaultColumnFilter.includedColumnsTable(actualDataSet.getTable(tableName),</span><br><span class="line">            expectDataSet.getTableMetaData(tableName).getColumns());</span><br><span class="line">          Assertion.assertEquals(expectDataSet.getTable(tableName), filteredTable);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// Clear up testing data if exists</span></span><br><span class="line">      <span class="keyword">if</span> (databaseTester != <span class="keyword">null</span>) &#123;</span><br><span class="line">        databaseTester.onTearDown();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTestClass</span><span class="params">(TestContext testCtx)</span> <span class="keyword">throws</span> Exception </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTestClass</span><span class="params">(TestContext testCtx)</span> <span class="keyword">throws</span> Exception </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="配置使用"><a href="#配置使用" class="headerlink" title="配置使用"></a>配置使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(classes = &#123;ServiceTestConfig.class&#125;)</span><br><span class="line"><span class="meta">@TestExecutionListeners</span>(&#123;ServiceTestExecutionListener.class&#125;)</span><br><span class="line"><span class="meta">@ActiveProfiles</span>(<span class="string">"test"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractServiceTest</span> <span class="keyword">extends</span> <span class="title">AbstractTransactionalJUnit4SpringContextTests</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><ul>
<li><a href="http://dbunit.sourceforge.net/howto.html" target="_blank" rel="external">DBUnit</a></li>
<li><a href="http://www.shenyanchao.cn/blog/2013/06/27/usage-dbunit/" target="_blank" rel="external">DBUnit使用案例</a></li>
<li><a href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/test/context/TestExecutionListener.html" target="_blank" rel="external">Spring TestExecutionListener</a></li>
<li><a href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/Configuration.html" target="_blank" rel="external">Spring Configuration</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/webservices/ws-springjava/index.html" target="_blank" rel="external">纯Java配置bean</a></li>
<li><a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/testing.html" target="_blank" rel="external">spring-framework-reference-testing</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/MIT线代笔记/" class="prev">PREV</a><a href="/2016/Hadoop-learning-notes-Data-Ingestion/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://michaelhuang.github.io">huangzhf</a>, <a href="https://github.com/pinggod/hexo-theme-apollo">apollo</a>, <a href="http://hexo.io">hexo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-75326623-1",'auto');ga('send','pageview');</script></body></html>